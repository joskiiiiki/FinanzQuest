user nginx;
error_log /var/log/nginx/error.log;

events {
    worker_connections 1024;
}

http {
    # Upstream blocks must be at http level, not inside server

    log_format detailed '$remote_addr - $remote_user [$time_local] '
    '"$request" $status $body_bytes_sent '
    '"$http_referer" "$http_user_agent" '
    'request_body: "$request_body"';


    client_max_body_size 10M;

    # Log to file with detailed format
    access_log /var/log/nginx/detailed_access.log detailed;


    # upstream frontend {
    #     server frontend:3000;
    # }

    upstream auth {
        server gotrue:9999;
    }


    upstream rest {
        server rest:3000;
    }

    server {
        listen 80;

        # Add your location blocks here
        location /auth/v1/ {
            proxy_pass http://auth/;

            # supabase auth has this weird quirk of not handling options requests for cors but still adds cors headers.
            # we remove them here to add our owns and handle cors ourselves

            # Hide CORS headers from upstream to avoid duplicates
            proxy_hide_header Access-Control-Allow-Origin;
            proxy_hide_header Access-Control-Allow-Methods;
            proxy_hide_header Access-Control-Allow-Headers;

            # Add our own CORS headers to all responses
            add_header 'Access-Control-Allow-Origin' '*' always;
            add_header 'Access-Control-Allow-Methods' 'GET,HEAD,PUT,PATCH,POST,DELETE,OPTIONS,TRACE,CONNECT' always;
            add_header 'Access-Control-Allow-Headers' 'Authorization,apikey,Content-Type,X-Client-Info,x-supabase-api-version' always;

            # Handle OPTIONS preflight (since auth service doesn't)
            if ($request_method = 'OPTIONS') {
                add_header 'Access-Control-Allow-Origin' '*' always;
                add_header 'Access-Control-Allow-Methods' 'GET,HEAD,PUT,PATCH,POST,DELETE,OPTIONS,TRACE,CONNECT' always;
                add_header 'Access-Control-Allow-Headers' 'Authorization,apikey,Content-Type,X-Client-Info,x-supabase-api-version' always;
                add_header 'Access-Control-Max-Age' '3600' always;
                add_header 'Content-Length' '0' always;
                return 204;
            }

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        # location / {
        #     proxy_pass http://frontend;
        #     proxy_set_header Host $host;
        #     proxy_set_header X-Real-IP $remote_addr;
        #     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        #     proxy_set_header X-Forwarded-Proto $scheme;
        #     proxy_set_header X-Forwarded-Host $http_host;
        # }
        location /rest/v1/ {
            proxy_pass http://rest/;
        }
    }
}
